<html lang='ko'>
  <head>
    <meta charset='UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <title>{{title}}</title>
    <link
      href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css'
      rel='stylesheet'
    />
    <link rel='stylesheet' href='/css/monitor.css' />
    <script src='https://cdn.jsdelivr.net/npm/chart.js'></script>
  </head>
  <body>
    <div class='container-fluid mt-4'>
      <h1 class='mb-4'>Webex Bot 모니터링 대시보드</h1>

      {{#if error}}
        <div class='alert alert-danger'>
          {{error}}
        </div>
      {{/if}}

      {{#if stats}}
        <!-- 봇 상태 개요 -->
        <div class='row mb-4'>
          <div class='col-md-12'>
            <div class='card'>
              <div class='card-header bg-primary text-white'>
                <h5 class='mb-0'>봇 상태 개요</h5>
              </div>
              <div class='card-body'>
                <div class='row'>
                  <div class='col-md-3'>
                    <div class='card bg-light'>
                      <div class='card-body text-center'>
                        <h6>상태</h6>
                        <h3>
                          {{#if stats.botStatus.isOnline}}
                            <span class='badge bg-success'>온라인</span>
                          {{else}}
                            <span class='badge bg-danger'>오프라인</span>
                          {{/if}}
                        </h3>
                      </div>
                    </div>
                  </div>
                  <div class='col-md-3'>
                    <div class='card bg-light'>
                      <div class='card-body text-center'>
                        <h6>마지막 활동</h6>
                        <h5>{{formatDate stats.botStatus.lastActivity}}</h5>
                      </div>
                    </div>
                  </div>
                  <div class='col-md-3'>
                    <div class='card bg-light'>
                      <div class='card-body text-center'>
                        <h6>총 웹훅 로그</h6>
                        <h3>{{stats.botStatus.totalWebhookLogs}}</h3>
                      </div>
                    </div>
                  </div>
                  <div class='col-md-3'>
                    <div class='card bg-light'>
                      <div class='card-body text-center'>
                        <h6>총 메시지</h6>
                        <h3>{{stats.botStatus.totalMessages}}</h3>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 현재 접속 중인 룸 -->
        <div class='row mb-4'>
          <div class='col-md-12'>
            <div class='card'>
              <div class='card-header bg-primary text-white'>
                <h5 class='mb-0'>현재 접속 중인 룸 ({{stats.activeRooms.length}})</h5>
              </div>
              <div class='card-body'>
                <div class='table-responsive'>
                  <table class='table table-striped table-hover'>
                    <thead>
                      <tr>
                        <th>룸 ID</th>
                        <th>룸 이름</th>
                        <th>유형</th>
                        <th>생성일시</th>
                        <th>마지막 활동</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{#each stats.activeRooms}}
                        <tr class='room-row' data-room-id='{{this.id}}'>
                          <td>{{truncateText this.id 10}}</td>
                          <td>{{this.title}}</td>
                          <td>{{this.type}}</td>
                          <td>{{formatDate this.created}}</td>
                          <td>{{formatDate this.lastActivity}}</td>
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 차트 -->
        <div class='row mb-4'>
          <div class='col-md-6'>
            <div class='card'>
              <div class='card-header bg-primary text-white'>
                <h5 class='mb-0'>이벤트 타입 분포</h5>
              </div>
              <div class='card-body'>
                <canvas id='eventChart'></canvas>
              </div>
            </div>
          </div>
          <div class='col-md-6'>
            <div class='card'>
              <div class='card-header bg-primary text-white'>
                <h5 class='mb-0'>리소스 타입 분포</h5>
              </div>
              <div class='card-body'>
                <canvas id='resourceChart'></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- 최근 웹훅 로그 -->
        <div class='row mb-4'>
          <div class='col-md-12'>
            <div class='card'>
              <div class='card-header bg-primary text-white'>
                <h5 class='mb-0'>최근 웹훅 로그</h5>
              </div>
              <div class='card-body'>
                <div class='table-responsive'>
                  <table class='table table-striped table-hover'>
                    <thead>
                      <tr>
                        <th>웹훅 ID</th>
                        <th>이벤트 타입</th>
                        <th>리소스 타입</th>
                        <th>생성일시</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{#each stats.recentWebhookLogs}}
                        <tr>
                          <td>{{this.webhookId}}</td>
                          <td>{{this.eventType}}</td>
                          <td>{{this.resourceType}}</td>
                          <td>{{formatDate this.createdAt}}</td>
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 최근 메시지 -->
        <div class='row mb-4'>
          <div class='col-md-12'>
            <div class='card'>
              <div class='card-header bg-primary text-white'>
                <h5 class='mb-0'>최근 메시지</h5>
              </div>
              <div class='card-body'>
                <div class='table-responsive'>
                  <table class='table table-striped table-hover'>
                    <thead>
                      <tr>
                        <th>메시지 ID</th>
                        <th>텍스트</th>
                        <th>사용자 ID</th>
                        <th>방 ID</th>
                        <th>생성일시</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{#each stats.recentMessages}}
                        <tr>
                          <td>{{this.ID}}</td>
                          <td>{{this.TEXT}}</td>
                          <td>{{this.userId}}</td>
                          <td>{{this.roomId}}</td>
                          <td>{{formatDate this.createdAt}}</td>
                        </tr>
                      {{/each}}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      {{/if}}

      <!-- 수동 새로고침 버튼 -->
      <div class='row mb-4'>
        <div class='col-md-12 text-center'>
          <button id='refreshButton' class='btn btn-primary'>수동 새로고침</button>
        </div>
      </div>
    </div>

    <script
      src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js'
    ></script>
    <script src='/js/monitor.js'></script>

    {{#if stats}}
      <!-- 차트 데이터를 숨겨진 요소로 전달 -->
      <div id='eventBreakdownData' style='display: none;'>{{json
          stats.eventBreakdown
        }}</div>
      <div id='resourceBreakdownData' style='display: none;'>{{json
          stats.resourceBreakdown
        }}</div>
      <script src='/js/chart-generator.js'></script>
    {{/if}}
  </body>
</html>